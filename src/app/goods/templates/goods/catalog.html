{% extends "main/base.html" %} 
{% load static %} 
{% load goods_tags %}   
{% block content %}

<!-- Search Results Header -->
{% if is_search %}
  {% if has_results %}
    <div class="alert alert-info mb-4">
      <h4 class="mb-0">Search results based on "{{ search_query }}"</h4>
    </div>
  {% else %}
    <div class="alert alert-warning mb-4">
      <h4 class="mb-0">Nothing found on "{{ search_query }}"</h4>
      <p class="mb-0 mt-2">Try searching with different keywords or browse our categories.</p>
    </div>
  {% endif %}
{% endif %}

{% if has_results %}
<div class="row">
  <!-- Filter form -->
  <div class="dropdown mb-2">
    <button class="btn btn-secondary dropdown-toggle btn-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      Filters
    </button>

    <form action="{% if request.GET.q %}{% url 'goods:search' %}{% else %}{% url 'goods:index' slug_url %}{% endif %}" method="get" class="dropdown-menu bg-dark" data-bs-theme="dark">
      <div class="form-check text-white mx-3">
        <input class="form-check-input" type="checkbox" name="on_sale" id="flexCheckDefault" value="on"/>
        {% if request.GET.q %}  
            <input type="hidden" name="q" value="{{ request.GET.q }}" />  
        {% endif %}
        <label class="form-check-label" for="flexCheckDefault">
          Products on Sale
        </label>
      </div>
      <p class="text-white mx-3 mt-3">Sort by:</p>
      <div class="form-check text-white mx-3">
        <input class="form-check-input" type="radio" name="order_by" id="flexRadioDefault1" value="default"/>
        <label class="form-check-label" for="flexRadioDefault1">
          Default
        </label>
      </div>
      <div class="form-check text-white mx-3">
        <input class="form-check-input" type="radio" name="order_by" id="flexRadioDefault2" value="price"/>
        <label class="form-check-label" for="flexRadioDefault2">
          From cheap to expensive
        </label>
      </div>
      <div class="form-check text-white mx-3">
        <input class="form-check-input" type="radio"name="order_by"id="flexRadioDefault3" value="-price"/>
        <label class="form-check-label" for="flexRadioDefault3">
          From expensive to cheap
        </label>
      </div>
      <button type="submit" class="btn btn-primary mx-3 mt-3">Apply</button>
    </form>
  </div>

  <div class="row">
    {% for good in goods %}
    <!-- Product card -->
    <div class="col-lg-4 col-md-6 p-4">
      <div class="card border-primary rounded custom-shadow position-relative">
        <!-- Discount badge in top-right corner -->
        {% if good.discount > 0 %}
        <span
          class="position-absolute top-0 end-0 badge bg-danger text-white m-2 px-2 py-1 rounded-pill shadow"
          style="z-index: 10"
        >
          -{{ good.discount }}%
        </span>
        {% endif %} {% if good.image %}
        <img src="{{ good.image.url }}" class="card-img-top" alt="..." />
        {% else %}
        <img
          src="{% static 'deps/images/Not found image.png' %}"
          class="card-img-top"
          alt="..."
        />
        {% endif %}
        <div class="card-body">
          <a href="{% url 'goods:product' good.id %}">
            {% if is_search and good.highlighted_name %}
              <p class="card-title">{{ good.highlighted_name|safe }}</p>
            {% else %}
              <p class="card-title">{{ good.name }}</p>
            {% endif %}
          </a>
          {% if is_search and good.highlighted_description %}
            <p class="card-text">{{ good.highlighted_description|truncate_html:100 }}</p>
          {% else %}
            <p class="card-text">{{ good.description|truncatechars:50 }}</p>
          {% endif %}
          <p class="product_id">id: {{ good.display_id }}</p>
          <div class="d-flex justify-content-between align-items-center">
            <div class="price-section">
              {% if good.discount > 0 %}
              <p class="mb-0">
                <small class="text-muted text-decoration-line-through"
                  >${{ good.price }}</small
                >
              </p>
              <p class="mb-0">
                <strong class="text-success fs-5"
                  >${{ good.calculate_discount }}</strong
                >
              </p>
              {% else %}
              <p class="mb-0">
                <strong class="fs-5">${{ good.price }}</strong>
              </p>
              {% endif %}
            </div>
            <a href="#" class="btn add-to-cart">
              <img class="mx-1" src="{% static "deps/icons/cart-plus.svg" %}"
              alt="Catalog Icon" width="32" height="32">
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<!-- Pagination -->
<nav aria-label="Page navigation example">
  <ul class="pagination justify-content-center my-4">
    <div class="custom-shadow d-flex">
      <li class="page-item {% if not goods.has_previous %}disabled{% endif %}">
        <a
          class="page-link"
          href="{% if goods.has_previous %}?page={{ goods.previous_page_number }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% else %}#{% endif %}"> Previous</a>
      </li>

      {% for page in goods.paginator.page_range %}
      {% if page > goods.number|add:-3 and page < goods.number|add:3 %}
      <li class="page-item {% if page == goods.number %}active{% endif %}">
        <a class="page-link" href="?page={{ page }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">{{ page }}</a>
      </li>
      {% endif %}
      {% endfor %}

      <li class="page-item {% if not goods.has_next %}disabled{% endif %}">
        <a
          class="page-link" 
          href="{% if goods.has_next %}?page={{ goods.next_page_number }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% else %}#{% endif %}"
        > Next</a>
      </li>
    </div>
  </ul>
</nav>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent dropdown from closing when clicking inside it
    document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
        dropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Allow dropdown to close when clicking Apply button
    document.querySelector('.dropdown-menu button[type="submit"]').addEventListener('click', function(e) {
        // Form will submit and page will reload, so dropdown will close naturally
    });
});
</script>

{% endblock %} 

{% block footer %}
<footer class="py-4 bg-dark">
  <div class="container">
    <p class="m-0 text-center text-white">Copyright &copy; iamurtazo 2023</p>
  </div>
</footer>
{% endblock %}
