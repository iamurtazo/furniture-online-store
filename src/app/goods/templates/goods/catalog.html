{% extends "base.html" %} 
{% load static %} 
{% load goods_tags %} 

{% block modal_cart %} 
{% include 'includes/cart_button.html' %} 
{% endblock %} 

{% block content %}

<!-- Search Results Header -->
{% if is_search %}
    <div class="mb-4">
        {% if has_results %}
        <div class="search-header-success">
            <div class="search-header-content">
                <i class="fas fa-search me-2"></i>
                <h4 class="mb-0 d-inline">Search results for "<strong>{{ search_query }}</strong>"</h4>
                <span class="badge bg-primary ms-2">{{ goods|length }} found</span>
            </div>
        </div>
        {% else %}
        <div class="search-header-empty">
            <div class="search-header-content">
                <i class="fas fa-inbox me-2"></i>
                <h4 class="mb-0 d-inline">No results for "<strong>{{ search_query }}</strong>"</h4>
            </div>
            <p class="mb-0 mt-2 text-muted">Try searching with different keywords or browse our categories.</p>
        </div>
        {% endif %}
    </div>
{% endif %} 

{% if has_results %}
<div class="catalog-container">
    <!-- Filter Sidebar -->
    <aside class="filter-sidebar">
        <button class="filter-toggle d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
            <i class="fas fa-sliders-h me-2"></i>Filters
            <i class="fas fa-chevron-down ms-auto"></i>
        </button>
        
        <div id="filterPanel" class="collapse d-lg-block filter-content">
            <form action="{% if request.GET.q %}{% url 'goods:search' %}{% else %}{% url 'goods:index' slug_url %}{% endif %}" method="get" class="filter-form">
                <!-- Hidden search query if applicable -->
                {% if request.GET.q %}
                <input type="hidden" name="q" value="{{ request.GET.q }}" />
                {% endif %}

                <!-- Sale Filter -->
                <div class="filter-group">
                    <h6 class="filter-title">
                        <i class="fas fa-tag me-2"></i>Promotions
                    </h6>
                    <div class="form-check filter-option">
                        <input class="form-check-input" type="checkbox" name="on_sale" id="onSaleCheck" value="on" {% if request.GET.on_sale %}checked{% endif %} />
                        <label class="form-check-label" for="onSaleCheck">
                            On Sale <span class="badge bg-danger ms-1">Hot</span>
                        </label>
                    </div>
                </div>

                <!-- Sort Filter -->
                <div class="filter-group">
                    <h6 class="filter-title">
                        <i class="fas fa-sort me-2"></i>Sort By
                    </h6>
                    <div class="form-check filter-option">
                        <input class="form-check-input" type="radio" name="order_by" id="sortDefault" value="default" {% if not request.GET.order_by or request.GET.order_by == 'default' %}checked{% endif %} />
                        <label class="form-check-label" for="sortDefault">
                            Most Relevant
                        </label>
                    </div>
                    <div class="form-check filter-option">
                        <input class="form-check-input" type="radio" name="order_by" id="sortPriceAsc" value="price" {% if request.GET.order_by == 'price' %}checked{% endif %} />
                        <label class="form-check-label" for="sortPriceAsc">
                            <i class="fas fa-arrow-up me-1"></i>Price: Low to High
                        </label>
                    </div>
                    <div class="form-check filter-option">
                        <input class="form-check-input" type="radio" name="order_by" id="sortPriceDesc" value="-price" {% if request.GET.order_by == '-price' %}checked{% endif %} />
                        <label class="form-check-label" for="sortPriceDesc">
                            <i class="fas fa-arrow-down me-1"></i>Price: High to Low
                        </label>
                    </div>
                </div>

                <!-- Apply Button -->
                <button type="submit" class="btn btn-primary w-100 filter-apply-btn">
                    <i class="fas fa-check me-2"></i>Apply Filters
                </button>
            </form>
        </div>
    </aside>

    <!-- Products Grid -->
    <div class="products-section">
        <div class="products-grid">
            {% for good in highlighted_goods|default:goods %}
            <!-- Product Card -->
            <div class="product-card-wrapper">
                <div class="product-card {% if good.is_out_of_stock %}is-out-of-stock{% endif %}">
                    <!-- Image Container -->
                    <div class="product-image-container">
                        <a href="{% url 'goods:product' good.id %}" class="product-image-link">
                            {% if good.image %}
                            <img src="{{ good.image.url }}" class="product-image {% if good.is_out_of_stock %}grayscale{% endif %}" alt="{{ good.name }}" />
                            {% else %}
                            <img src="{% static 'deps/images/Not found image.png' %}" class="product-image {% if good.is_out_of_stock %}grayscale{% endif %}" alt="{{ good.name }}" />
                            {% endif %}
                        </a>
                        
                        <!-- Overlay with Quick Actions -->
                        <div class="product-overlay">
                            <a href="{% url 'goods:product' good.id %}" class="btn btn-sm btn-light btn-view">
                                <i class="fas fa-eye me-1"></i>Quick View
                            </a>
                        </div>

                        <!-- Stock Badges -->
                        <div class="badges-container">
                            {% if good.is_out_of_stock %}
                            <span class="badge badge-stock-out">
                                <i class="fas fa-times-circle me-1"></i>Out of Stock
                            </span>
                            {% elif good.is_low_stock %}
                            <span class="badge badge-stock-low">
                                <i class="fas fa-exclamation-triangle me-1"></i>Only {{ good.quantity }} left
                            </span>
                            {% endif %}

                            {% if good.discount > 0 %}
                            <span class="badge badge-discount">
                                -{{ good.discount }}%
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Card Body -->
                    <div class="product-body">
                        <a href="{% url 'goods:product' good.id %}" class="product-title-link">
                            <h5 class="product-title">
                                {% if is_search and good.highlighted_name %}
                                {{ good.highlighted_name|safe }}
                                {% else %}
                                {{ good.name }}
                                {% endif %}
                            </h5>
                        </a>

                        <div class="product-description">
                            {% if is_search and good.highlighted_description %}
                            {{ good.highlighted_description|truncate_html:100 }}
                            {% else %}
                            {{ good.description|truncatechars:50 }}
                            {% endif %}
                        </div>

                        <p class="product-id"><small>SKU: {{ good.display_id }}</small></p>

                        <!-- Stock Information Bar -->
                        <div class="stock-info-bar">
                            {% if good.is_out_of_stock %}
                            <div class="stock-bar stock-empty"></div>
                            <span class="stock-text">Out of Stock</span>
                            {% elif good.is_low_stock %}
                            <div class="stock-bar stock-low"></div>
                            <span class="stock-text">{{ good.quantity }} in stock</span>
                            {% else %}
                            <div class="stock-bar stock-available"></div>
                            <span class="stock-text">In stock</span>
                            {% endif %}
                        </div>

                        <!-- Footer: Price & Action -->
                        <div class="product-footer">
                            <div class="price-section">
                                {% if good.discount > 0 %}
                                <div class="price-group">
                                    <span class="price-original">${{ good.price }}</span>
                                    <span class="price-current">${{ good.get_discounted_price }}</span>
                                </div>
                                {% else %}
                                <div class="price-group">
                                    <span class="price-current">${{ good.price }}</span>
                                </div>
                                {% endif %}
                            </div>

                            {% if good.is_out_of_stock %}
                            <button class="btn btn-cart btn-disabled" disabled>
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            {% else %}
                            <a href="{% url 'carts:cart_add' %}" class="btn btn-cart btn-active add-to-cart" data-good-id="{{ good.id }}" title="Add to cart">
                                {% csrf_token %}
                                <i class="fas fa-shopping-cart"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Pagination -->
{% if page_obj.paginator.num_pages > 1 %}
<div class="pagination-wrapper">
    <nav aria-label="Page navigation" class="mt-5">
        <ul class="pagination justify-content-center pagination-custom">
            <!-- Previous button -->
            <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                <a class="page-link" href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% else %}#{% endif %}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>

            <!-- Page numbers -->
            {% for page in page_obj.paginator.page_range %}
                {% if page >= page_obj.number|add:-2 and page <= page_obj.number|add:2 %}
                <li class="page-item {% if page == page_obj.number %}active{% endif %}">
                    <a class="page-link" href="?page={{ page }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                        {{ page }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            <!-- Next button -->
            <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                <a class="page-link" href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}{% if on_sale %}&on_sale={{ on_sale }}{% endif %}{% if order_by and order_by != 'default' %}&order_by={{ order_by }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% else %}#{% endif %}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Handle filter sidebar toggle on mobile
        const filterToggle = document.querySelector(".filter-toggle");
        const filterPanel = document.getElementById("filterPanel");
        
        if (filterToggle) {
            filterToggle.addEventListener("click", function () {
                this.classList.toggle("active");
            });
        }

        // Prevent filter dropdown from closing when clicking inside it
        filterPanel?.addEventListener("click", function (e) {
            if (e.target.tagName !== "BUTTON") {
                e.stopPropagation();
            }
        });

        // Add to cart animation
        document.querySelectorAll(".add-to-cart").forEach(function (btn) {
            btn.addEventListener("click", function (e) {
                e.preventDefault();
                const btn = e.target.closest(".add-to-cart");
                btn.classList.add("adding");
                
                setTimeout(() => {
                    btn.classList.remove("adding");
                }, 600);
            });
        });
    });
</script>
{% endblock %} {% block footer %}
<footer class="py-4 bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; iamurtazo 2023</p>
    </div>
</footer>
{% endblock %}
